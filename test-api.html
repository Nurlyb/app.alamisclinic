<!DOCTYPE html>
<html>
<head>
    <title>API Test</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: monospace; padding: 20px; }
        button { margin: 10px 0; padding: 10px; }
        pre { background: #f4f4f4; padding: 10px; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>üè• –¢–µ—Å—Ç API –ö–ª–∏–Ω–∏–∫–∏</h1>
    
    <div id="tokenStatus" style="padding: 10px; background: #f0f0f0; border-radius: 5px; margin-bottom: 10px;">
        <strong>–°—Ç–∞—Ç—É—Å —Ç–æ–∫–µ–Ω–∞:</strong> <span id="tokenInfo">‚ùå –ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω</span>
    </div>
    
    <button onclick="testLogin()">1. –¢–µ—Å—Ç –õ–æ–≥–∏–Ω–∞</button>
    <button onclick="testMe()">2. –¢–µ—Å—Ç /api/auth/me</button>
    <button onclick="testDepartments()">3. –¢–µ—Å—Ç /api/departments</button>
    <button onclick="testPatients()">4. –¢–µ—Å—Ç /api/patients</button>
    <button onclick="clearOutput()" style="background: #666; margin-left: 20px;">üóë –û—á–∏—Å—Ç–∏—Ç—å</button>
    
    <div id="output"></div>

    <script>
        let accessToken = null;

        function log(message, isError = false) {
            const output = document.getElementById('output');
            const className = isError ? 'error' : 'success';
            output.innerHTML += `<pre class="${className}">${message}</pre>`;
        }

        function clearOutput() {
            document.getElementById('output').innerHTML = '';
            log('üîÑ –í—ã–≤–æ–¥ –æ—á–∏—â–µ–Ω. –ì–æ—Ç–æ–≤ –∫ –Ω–æ–≤—ã–º —Ç–µ—Å—Ç–∞–º!');
        }

        function updateTokenStatus() {
            const tokenInfo = document.getElementById('tokenInfo');
            if (accessToken) {
                tokenInfo.innerHTML = '‚úÖ –¢–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω';
                tokenInfo.style.color = 'green';
            } else {
                tokenInfo.innerHTML = '‚ùå –ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω';
                tokenInfo.style.color = 'red';
            }
        }

        async function testLogin() {
            try {
                log('üîÑ –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –ª–æ–≥–∏–Ω...');
                
                const response = await fetch('http://localhost:3000/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        phone: '+77001234571',
                        password: 'clinic123'
                    })
                });

                log(`üì° –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞: ${response.status}`);
                
                const data = await response.json();
                
                if (data.success) {
                    accessToken = data.tokens.accessToken;
                    updateTokenStatus();
                    log('‚úÖ –õ–æ–≥–∏–Ω —É—Å–ø–µ—à–µ–Ω!');
                    log(`üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${data.user.name} (${data.user.role})`);
                    log(`üîë –î–ª–∏–Ω–∞ —Ç–æ–∫–µ–Ω–∞: ${accessToken.length} —Å–∏–º–≤–æ–ª–æ–≤`);
                } else {
                    log(`‚ùå –û—à–∏–±–∫–∞ –ª–æ–≥–∏–Ω–∞: ${data.error}`, true);
                }
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, true);
                log(`üí° –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ http://localhost:3000`, true);
            }
        }

        async function testMe() {
            if (!accessToken) {
                log('‚ùå –°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –ª–æ–≥–∏–Ω!', true);
                return;
            }

            try {
                log('üîÑ –ü—Ä–æ–≤–µ—Ä–∫–∞ /api/auth/me...');
                
                const response = await fetch('http://localhost:3000/api/auth/me', {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });

                log(`üì° –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞: ${response.status}`);
                
                const data = await response.json();
                
                if (data.success) {
                    log('‚úÖ /api/auth/me —Ä–∞–±–æ—Ç–∞–µ—Ç!');
                    log(`üë§ ${data.user.name}`);
                    log(`üìã –†–æ–ª—å: ${data.user.role}`);
                    log(`üîê –†–∞–∑—Ä–µ—à–µ–Ω–∏–π: ${data.permissions.length}`);
                } else {
                    log(`‚ùå –û—à–∏–±–∫–∞: ${data.error}`, true);
                }
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, true);
            }
        }

        async function testDepartments() {
            if (!accessToken) {
                log('‚ùå –°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –ª–æ–≥–∏–Ω!', true);
                return;
            }

            try {
                log('üîÑ –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –æ—Ç–¥–µ–ª–µ–Ω–∏–π...');
                
                const response = await fetch('http://localhost:3000/api/departments', {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });

                log(`üì° –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞: ${response.status}`);
                
                const data = await response.json();
                
                if (data.success) {
                    log('‚úÖ /api/departments —Ä–∞–±–æ—Ç–∞–µ—Ç!');
                    log(`üè• –ù–∞–π–¥–µ–Ω–æ –æ—Ç–¥–µ–ª–µ–Ω–∏–π: ${data.data.length}`);
                    data.data.slice(0, 3).forEach(dept => {
                        log(`  ‚Ä¢ ${dept.name}`);
                    });
                } else {
                    log(`‚ùå –û—à–∏–±–∫–∞: ${data.error}`, true);
                }
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, true);
            }
        }

        async function testPatients() {
            if (!accessToken) {
                log('‚ùå –°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –ª–æ–≥–∏–Ω!', true);
                return;
            }

            try {
                log('üîÑ –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤...');
                
                const response = await fetch('http://localhost:3000/api/patients?page=1&limit=5', {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });

                log(`üì° –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞: ${response.status}`);
                
                const data = await response.json();
                
                if (data.success) {
                    log('‚úÖ /api/patients —Ä–∞–±–æ—Ç–∞–µ—Ç!');
                    log(`üë• –ü–æ–∫–∞–∑–∞–Ω–æ –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤: ${data.data.length}`);
                    log(`üìä –í—Å–µ–≥–æ –≤ –±–∞–∑–µ: ${data.pagination.total}`);
                    data.data.slice(0, 3).forEach(patient => {
                        log(`  ‚Ä¢ ${patient.fullName} (${patient.phone})`);
                    });
                } else {
                    log(`‚ùå –û—à–∏–±–∫–∞: ${data.error}`, true);
                }
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, true);
            }
        }
    </script>
</body>
</html>
