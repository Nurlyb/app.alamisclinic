# Исправление проблемы с выходом при обновлении страницы ✅

## Проблема
При обновлении страницы (F5) пользователь выходил из системы, несмотря на то, что токены были сохранены в localStorage через zustand persist.

## Причина
Zustand persist восстанавливал данные из localStorage, но:
1. Флаг `isAuthenticated` не устанавливался автоматически при восстановлении
2. Не было проверки валидности токенов при загрузке приложения
3. Токены могли быть просрочены, но система пыталась их использовать

## Решение

### 1. Создан компонент AuthInitializer
**Файл:** `components/auth/AuthInitializer.tsx`

Компонент выполняет следующие задачи:
- Проверяет наличие токенов при загрузке приложения
- Валидирует токены через запрос к `/api/auth/me`
- Обновляет данные пользователя если токен валиден
- Разлогинивает пользователя если токен невалиден или просрочен
- Показывает экран загрузки во время инициализации

### 2. Обновлен RootLayout
**Файл:** `app/layout.tsx`

Добавлен `AuthInitializer` в дерево компонентов:
```tsx
<QueryProvider>
  <AuthInitializer>
    {children}
  </AuthInitializer>
  <ToastProvider />
</QueryProvider>
```

### 3. Улучшен AuthStore
**Файл:** `lib/store/auth.ts`

Добавлены улучшения:
- `onRehydrateStorage` callback для автоматической установки `isAuthenticated` при восстановлении из localStorage
- Обновлен метод `updateUser` для установки `isAuthenticated: true`

## Как это работает

### При первом входе:
1. Пользователь вводит логин/пароль
2. Получает токены (access + refresh)
3. Токены сохраняются в localStorage через zustand persist
4. Устанавливается `isAuthenticated: true`

### При обновлении страницы:
1. Zustand persist восстанавливает данные из localStorage
2. `onRehydrateStorage` проверяет наличие токенов и устанавливает `isAuthenticated: true`
3. `AuthInitializer` запускается и проверяет валидность токенов через API
4. Если токен валиден - обновляет данные пользователя
5. Если токен невалиден - разлогинивает и редиректит на /login

### При истечении токена:
1. API interceptor в `api/client.ts` ловит ошибку 401
2. Пытается обновить токен через refresh token
3. Если успешно - обновляет access token и повторяет запрос
4. Если неуспешно - разлогинивает пользователя

## Преимущества решения

✅ Пользователь остаётся авторизованным после обновления страницы
✅ Автоматическая проверка валидности токенов
✅ Автоматическое обновление просроченных токенов
✅ Плавный UX с экраном загрузки
✅ Безопасность - невалидные токены автоматически удаляются

## Тестирование

1. Войдите в систему
2. Обновите страницу (F5)
3. Убедитесь, что остались авторизованы
4. Проверьте, что данные пользователя отображаются корректно

## Дополнительные улучшения

Можно добавить в будущем:
- Автоматическое обновление токена за N минут до истечения
- Показ уведомления о скором истечении сессии
- Возможность "запомнить меня" с более длительным refresh token
